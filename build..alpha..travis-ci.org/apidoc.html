<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/richardzyx/node-microservice#readme"

    >node-microservice (v0.6.0)</a>
</h1>
<h4>Clean, Direct, Easy to Scale solution to Node Microservice Framework</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-microservice">module node-microservice</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-microservice.connect_amqp">
            function <span class="apidocSignatureSpan">node-microservice.</span>connect_amqp
            <span class="apidocSignatureSpan">(amqp_url, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-microservice.send">
            function <span class="apidocSignatureSpan">node-microservice.</span>send
            <span class="apidocSignatureSpan">(serviceName, message, timeout)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-microservice.server_listen">
            function <span class="apidocSignatureSpan">node-microservice.</span>server_listen
            <span class="apidocSignatureSpan">(amqp_url, service_name, pro, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-microservice.connect_amqp">module node-microservice.connect_amqp</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-microservice.connect_amqp.connect_amqp">
            function <span class="apidocSignatureSpan">node-microservice.</span>connect_amqp
            <span class="apidocSignatureSpan">(amqp_url, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-microservice.send">module node-microservice.send</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-microservice.send.send">
            function <span class="apidocSignatureSpan">node-microservice.</span>send
            <span class="apidocSignatureSpan">(serviceName, message, timeout)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.node-microservice.server_listen">module node-microservice.server_listen</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.node-microservice.server_listen.server_listen">
            function <span class="apidocSignatureSpan">node-microservice.</span>server_listen
            <span class="apidocSignatureSpan">(amqp_url, service_name, pro, options)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-microservice" id="apidoc.module.node-microservice">module node-microservice</a></h1>


    <h2>
        <a href="#apidoc.element.node-microservice.connect_amqp" id="apidoc.element.node-microservice.connect_amqp">
        function <span class="apidocSignatureSpan">node-microservice.</span>connect_amqp
        <span class="apidocSignatureSpan">(amqp_url, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect_amqp = function (amqp_url, options){
    return amqp.connect(amqp_url).then(function (conn) {
        return conn.createChannel().then(
            function onFulfilled(ch) {
                if(options){
                    logger=new graylog2.graylog(options);
                }
                mqService.ch=ch;
                var ok = ch.assertQueue(&#x27;&#x27;, {exclusive: true})
                    .then(function (qok) {
                        return qok.queue;
                    });
                mqService.ok=ok;
                return ok;
            });
    }).then(null, function(err) {
        console.error(&#x22;Exception handled, reconnecting...\nDetail:\n&#x22; + err);
        setTimeout(exports.connect_amqp(amqp_url), 5000);
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
                    return qok.queue;
                });
            mqService.ok=ok;
            return ok;
        });
}).then(null, function(err) {
    console.error(&#x22;Exception handled, reconnecting...\nDetail:\n&#x22; + err);
    setTimeout(exports.<span class="apidocCodeKeywordSpan">connect_amqp</span>(amqp_url), 5000);
});
};

exports.send=function(serviceName,message,timeout){
var messageStr=JSON.stringify(message);
var q = serviceName + &#x22;_queue&#x22;;
var corrId = uuid();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-microservice.send" id="apidoc.element.node-microservice.send">
        function <span class="apidocSignatureSpan">node-microservice.</span>send
        <span class="apidocSignatureSpan">(serviceName, message, timeout)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">send = function (serviceName, message, timeout){
    var messageStr=JSON.stringify(message);
    var q = serviceName + &#x22;_queue&#x22;;
    var corrId = uuid();
    var ok = mqService.ok;
    var ch = mqService.ch;
    //create a new Promise and waiting for resolve
    var df=defer(timeout);
    cacheTable[corrId]=df;
    ok = ok.then(function (queue) {
        return ch.consume(queue, maybeAnswer, {noAck: true})
            .then(function () {
                return queue;
            });
    });
    ok = ok.then(function (queue) {
        //console.log(&#x27; [x] Requesting&#x27;+ message);
        ch.sendToQueue(q, new Buffer(messageStr), {
            correlationId: corrId, replyTo: queue
        });
    });
    return df.promise.then(
        function onFulfilled(rs){
            if(JSON.parse(rs) == corrId) {
                rs = undefined;
                return rs;
            }else{
                logger.log(&#x22;Success&#x22;,&#x22;request@#$&#x22;+messageStr+&#x22;====response@#$&#x22;+rs,{duration:new Date().getTime()-df.timestamp, service
:serviceName});
                return JSON.parse(rs);
            }
        },
        function onReject(err){
            logger.error(&#x22;Timeout&#x22;,&#x22;request@#$&#x22;+messageStr+&#x22;====response@#$&#x22;+err,{duration:new Date().getTime()-df.timestamp, service
:serviceName});
            throw new Error(err);
        }
    );
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.node-microservice.server_listen" id="apidoc.element.node-microservice.server_listen">
        function <span class="apidocSignatureSpan">node-microservice.</span>server_listen
        <span class="apidocSignatureSpan">(amqp_url, service_name, pro, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">server_listen = function (amqp_url, service_name, pro, options){//pro has to be a promise
    var durable;
    if(options.durable) {
        durable = options.durable;
    }else
        durable = false;

    var queueOptions={durable: durable};

    if(options.messageTtl)
        queueOptions.messageTtl = options.messageTtl;

    amqp.connect(amqp_url).then(function(conn) {
        process.once(&#x27;SIGINT&#x27;, function() { conn.close(); });
        return conn.createChannel().then(function(ch) {
            var q = service_name + &#x22;_queue&#x22;;
            var ok = ch.assertQueue(q, queueOptions);
            var ok = ok.then(function() {
                if(options.prefetch_num) {
                    ch.prefetch(options.prefetch_num);
                }
                return ch.consume(q, reply,{noAck:options.noAck});
            });
            return ok.then(function() {
                console.log(&#x27; [x] Awaiting requests&#x27;);
            });

            function reply(msg) {
                var content=JSON.parse(msg.content.toString());
                pro(content).then(
                    function onFulfilled(response){
                        if(!response) {
                            response = msg.properties.correlationId;
                        }
                        ch.sendToQueue(msg.properties.replyTo,
                            new Buffer(JSON.stringify(response)),
                            {correlationId: msg.properties.correlationId});
                        if(!options.noAck) {
                            ch.ack(msg);
                        }
                    },
                    function onReject(err){
                        console.log(err);
                        ch.sendToQueue(msg.properties.replyTo,
                            new Buffer(JSON.stringify(err)),
                            {correlationId: msg.properties.correlationId});
                        if(!options.noAck) {
                            if(options.ensureDone){
                                ch.nack(msg);
                            }else {
                                ch.ack(msg);
                            }
                        }
                    }
                );
            }
        });
    }).then(null, function(err){
        console.error(&#x22;Server has problem connecting, shutting down...\nDetail:\n&#x22; + err);
        throw err;
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-microservice.connect_amqp" id="apidoc.module.node-microservice.connect_amqp">module node-microservice.connect_amqp</a></h1>


    <h2>
        <a href="#apidoc.element.node-microservice.connect_amqp.connect_amqp" id="apidoc.element.node-microservice.connect_amqp.connect_amqp">
        function <span class="apidocSignatureSpan">node-microservice.</span>connect_amqp
        <span class="apidocSignatureSpan">(amqp_url, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect_amqp = function (amqp_url, options){
    return amqp.connect(amqp_url).then(function (conn) {
        return conn.createChannel().then(
            function onFulfilled(ch) {
                if(options){
                    logger=new graylog2.graylog(options);
                }
                mqService.ch=ch;
                var ok = ch.assertQueue(&#x27;&#x27;, {exclusive: true})
                    .then(function (qok) {
                        return qok.queue;
                    });
                mqService.ok=ok;
                return ok;
            });
    }).then(null, function(err) {
        console.error(&#x22;Exception handled, reconnecting...\nDetail:\n&#x22; + err);
        setTimeout(exports.connect_amqp(amqp_url), 5000);
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
                    return qok.queue;
                });
            mqService.ok=ok;
            return ok;
        });
}).then(null, function(err) {
    console.error(&#x22;Exception handled, reconnecting...\nDetail:\n&#x22; + err);
    setTimeout(exports.<span class="apidocCodeKeywordSpan">connect_amqp</span>(amqp_url), 5000);
});
};

exports.send=function(serviceName,message,timeout){
var messageStr=JSON.stringify(message);
var q = serviceName + &#x22;_queue&#x22;;
var corrId = uuid();
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-microservice.send" id="apidoc.module.node-microservice.send">module node-microservice.send</a></h1>


    <h2>
        <a href="#apidoc.element.node-microservice.send.send" id="apidoc.element.node-microservice.send.send">
        function <span class="apidocSignatureSpan">node-microservice.</span>send
        <span class="apidocSignatureSpan">(serviceName, message, timeout)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">send = function (serviceName, message, timeout){
    var messageStr=JSON.stringify(message);
    var q = serviceName + &#x22;_queue&#x22;;
    var corrId = uuid();
    var ok = mqService.ok;
    var ch = mqService.ch;
    //create a new Promise and waiting for resolve
    var df=defer(timeout);
    cacheTable[corrId]=df;
    ok = ok.then(function (queue) {
        return ch.consume(queue, maybeAnswer, {noAck: true})
            .then(function () {
                return queue;
            });
    });
    ok = ok.then(function (queue) {
        //console.log(&#x27; [x] Requesting&#x27;+ message);
        ch.sendToQueue(q, new Buffer(messageStr), {
            correlationId: corrId, replyTo: queue
        });
    });
    return df.promise.then(
        function onFulfilled(rs){
            if(JSON.parse(rs) == corrId) {
                rs = undefined;
                return rs;
            }else{
                logger.log(&#x22;Success&#x22;,&#x22;request@#$&#x22;+messageStr+&#x22;====response@#$&#x22;+rs,{duration:new Date().getTime()-df.timestamp, service
:serviceName});
                return JSON.parse(rs);
            }
        },
        function onReject(err){
            logger.error(&#x22;Timeout&#x22;,&#x22;request@#$&#x22;+messageStr+&#x22;====response@#$&#x22;+err,{duration:new Date().getTime()-df.timestamp, service
:serviceName});
            throw new Error(err);
        }
    );
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.node-microservice.server_listen" id="apidoc.module.node-microservice.server_listen">module node-microservice.server_listen</a></h1>


    <h2>
        <a href="#apidoc.element.node-microservice.server_listen.server_listen" id="apidoc.element.node-microservice.server_listen.server_listen">
        function <span class="apidocSignatureSpan">node-microservice.</span>server_listen
        <span class="apidocSignatureSpan">(amqp_url, service_name, pro, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">server_listen = function (amqp_url, service_name, pro, options){//pro has to be a promise
    var durable;
    if(options.durable) {
        durable = options.durable;
    }else
        durable = false;

    var queueOptions={durable: durable};

    if(options.messageTtl)
        queueOptions.messageTtl = options.messageTtl;

    amqp.connect(amqp_url).then(function(conn) {
        process.once(&#x27;SIGINT&#x27;, function() { conn.close(); });
        return conn.createChannel().then(function(ch) {
            var q = service_name + &#x22;_queue&#x22;;
            var ok = ch.assertQueue(q, queueOptions);
            var ok = ok.then(function() {
                if(options.prefetch_num) {
                    ch.prefetch(options.prefetch_num);
                }
                return ch.consume(q, reply,{noAck:options.noAck});
            });
            return ok.then(function() {
                console.log(&#x27; [x] Awaiting requests&#x27;);
            });

            function reply(msg) {
                var content=JSON.parse(msg.content.toString());
                pro(content).then(
                    function onFulfilled(response){
                        if(!response) {
                            response = msg.properties.correlationId;
                        }
                        ch.sendToQueue(msg.properties.replyTo,
                            new Buffer(JSON.stringify(response)),
                            {correlationId: msg.properties.correlationId});
                        if(!options.noAck) {
                            ch.ack(msg);
                        }
                    },
                    function onReject(err){
                        console.log(err);
                        ch.sendToQueue(msg.properties.replyTo,
                            new Buffer(JSON.stringify(err)),
                            {correlationId: msg.properties.correlationId});
                        if(!options.noAck) {
                            if(options.ensureDone){
                                ch.nack(msg);
                            }else {
                                ch.ack(msg);
                            }
                        }
                    }
                );
            }
        });
    }).then(null, function(err){
        console.error(&#x22;Server has problem connecting, shutting down...\nDetail:\n&#x22; + err);
        throw err;
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
